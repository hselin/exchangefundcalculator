<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exchange Fund Calculator | Sell or Exchange?</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Charting Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
    <link rel="manifest" href="site.webmanifest">
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .gradient-text {
            background: linear-gradient(to right, #10B981, #3B82F6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 320px;
            max-height: 40vh;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        input[type=range] {
            touch-action: pan-y; /* Prevents accidental horizontal page scroll on mobile */
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #10B981; /* emerald-500 */
            cursor: pointer;
            border-radius: 50%;
        }
        input[type=range]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #10B981; /* emerald-500 */
            cursor: pointer;
            border-radius: 50%;
        }
        .toggle-checkbox:checked {
            right: 0;
            border-color: #10B981;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #10B981;
        }
        input[type=range].slider-error::-webkit-slider-thumb {
            background: #ef4444; /* red-500 for error state */
        }
        input[type=range].slider-error::-moz-range-thumb {
             background: #ef4444; /* red-500 for error state */
        }
        .tooltip {
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        .tooltip-visible {
            opacity: 1;
            pointer-events: auto;
        }
        /* More targeted fix for horizontal scroll */
        .container {
            overflow-x: hidden;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-300">

    <!-- HERO SECTION -->
    <header class="pt-16 pb-20 md:pt-20 md:pb-28 text-center">
        <div class="container mx-auto px-6">
            <h1 class="text-4xl md:text-6xl font-bold text-white leading-tight mb-4">
                Your <span class="gradient-text">Optimal Diversification Path</span>
            </h1>
            <p class="max-w-3xl mx-auto text-lg md:text-xl text-gray-400 leading-relaxed">
                What’s the smartest way to diversify your stock position? This tool guides you to the optimal financial path by projecting the portfolio's value if you sell now versus use an exchange fund, and pinpointing the precise break-even expense ratio that makes your choice clear.
            </p>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <section class="relative z-10 -mt-12 md:-mt-20 pb-12 md:pb-16">
        <div class="container mx-auto px-4">
            <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">

                <!-- Left Panel: Inputs -->
                <aside class="lg:col-span-1 bg-gray-900 p-6 rounded-2xl shadow-lg border border-gray-700">
                    <h2 class="text-xl md:text-2xl font-bold mb-6 text-white text-center">Financial Inputs</h2>

                    <div class="space-y-6">
                        <!-- Initial Investment & Tax Rate -->
                        <div>
                            <h3 class="text-lg font-semibold mb-4 text-emerald-400">Initial Investment & Tax Rate</h3>
                            <div class="space-y-4">
                                 <div>
                                    <div class="flex justify-between items-center">
                                        <label for="currentValue" class="block text-xs md:text-sm font-medium text-gray-300">Current Market Value ($)</label>
                                        <div class="relative group">
                                            <span class="text-emerald-400 cursor-help">ⓘ</span>
                                            <div class="tooltip absolute bottom-full mb-2 w-60 bg-gray-800 border border-gray-700 text-white text-xs rounded-lg p-2 z-10">The current market price of your concentrated stock position.</div>
                                        </div>
                                    </div>
                                    <input type="text" id="currentValue" inputmode="numeric" class="mt-1 block w-full rounded-md bg-gray-700 text-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 text-lg px-2 py-1 border border-gray-600">
                                </div>
                                <div>
                                     <div class="flex justify-between items-center">
                                        <label for="costBasis" class="block text-xs md:text-sm font-medium text-gray-300">Cost Basis ($)</label>
                                        <div class="relative group">
                                            <span class="text-emerald-400 cursor-help">ⓘ</span>
                                            <div class="tooltip absolute bottom-full mb-2 w-64 bg-gray-800 border border-gray-700 text-white text-xs rounded-lg p-2 z-10">How much you paid for the concentrated stock position, including commissions.</div>
                                        </div>
                                    </div>
                                    <input type="text" id="costBasis" inputmode="numeric" class="mt-1 block w-full rounded-md bg-gray-700 text-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 text-lg px-2 py-1 border border-gray-600">
                                </div>
                                <div>
                                    <div class="flex justify-between items-center">
                                        <label for="taxRate" class="block text-xs md:text-sm font-medium text-gray-300">Tax Rate (%)</label>
                                        <div class="relative group">
                                            <span class="text-emerald-400 cursor-help">ⓘ</span>
                                            <div class="tooltip absolute bottom-full mb-2 w-64 bg-gray-800 border border-gray-700 text-white text-xs rounded-lg p-2 z-10">Your combined federal and state tax rate.</div>
                                        </div>
                                    </div>
                                    <input type="range" id="taxRate" min="10" max="50" step="0.1" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                                    <span id="taxRateValue" class="block text-right font-semibold text-emerald-400"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Return Assumptions -->
                        <div class="pt-4 border-t border-gray-700">
                            <h3 class="text-lg font-semibold mb-4 text-emerald-400">Return Assumptions</h3>
                             <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between items-center">
                                        <label for="scenarioAAnnualReturn" class="block text-xs md:text-sm font-medium text-gray-300">Sell & Reinvest Annual Return (%)</label>
                                        <div class="relative group">
                                            <span class="text-emerald-400 cursor-help">ⓘ</span>
                                            <div class="tooltip absolute bottom-full mb-2 w-64 bg-gray-800 border border-gray-700 text-white text-xs rounded-lg p-2 z-10">The expected annual growth rate of the investment you'd buy after selling your concentrated stock. The S&P 500 has averaged around 10% annually since 1957.</div>
                                        </div>
                                    </div>
                                    <input type="range" id="scenarioAAnnualReturn" min="1" max="15" step="0.1" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                                    <span id="scenarioAAnnualReturnValue" class="block text-right font-semibold text-emerald-400"></span>
                                </div>
                                <div>
                                     <div class="flex justify-between items-center">
                                        <label for="exchangeFundAnnualReturn" class="block text-xs md:text-sm font-medium text-gray-300">Exchange Fund Annual Return (%)</label>
                                        <div class="relative group">
                                            <span class="text-emerald-400 cursor-help">ⓘ</span>
                                            <div class="tooltip absolute bottom-full mb-2 w-64 bg-gray-800 border border-gray-700 text-white text-xs rounded-lg p-2 z-10">The expected annual growth rate of the exchange fund before fees. The S&P 500 has averaged about 10% annually since 1957.</div>
                                        </div>
                                    </div>
                                    <input type="range" id="exchangeFundAnnualReturn" min="1" max="15" step="0.1" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                                    <span id="exchangeFundAnnualReturnValue" class="block text-right font-semibold text-emerald-400"></span>
                                </div>
                                <div>
                                    <div class="flex justify-between items-center">
                                        <label for="postFundAnnualReturn" class="block text-xs md:text-sm font-medium text-gray-300">Exchange Fund Post-Redemption Annual Return (%)</label>
                                        <div class="relative group">
                                            <span class="text-emerald-400 cursor-help">ⓘ</span>
                                            <div class="tooltip absolute bottom-full mb-2 w-64 bg-gray-800 border border-gray-700 text-white text-xs rounded-lg p-2 z-10">The expected annual growth rate of the investment you’d own after exiting the exchange fund. The S&P 500 has averaged about 10% annually since 1957.</div>
                                        </div>
                                    </div>
                                    <input type="range" id="postFundAnnualReturn" min="1" max="15" step="0.1" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                                    <span id="postFundAnnualReturnValue" class="block text-right font-semibold text-emerald-400"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Market Assumptions -->
                        <div class="pt-4 border-t border-gray-700">
                            <h3 class="text-lg font-semibold mb-4 text-emerald-400">Market Assumptions</h3>
                            <div class="space-y-4">
                                 <div>
                                    <div class="flex justify-between items-center">
                                        <label for="inflation" class="block text-xs md:text-sm font-medium text-gray-300">Annual Inflation (%)</label>
                                         <div class="relative group">
                                            <span class="text-emerald-400 cursor-help">ⓘ</span>
                                            <div class="tooltip absolute bottom-full mb-2 w-64 bg-gray-800 border border-gray-700 text-white text-xs rounded-lg p-2 z-10">The expected average annual inflation rate over your investment horizon. This is used to calculate real, after-tax returns. Historically, U.S. inflation has averaged about 3.3% annually.</div>
                                        </div>
                                    </div>
                                    <input type="range" id="inflation" min="0" max="10" step="0.1" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                                    <span id="inflationValue" class="block text-right font-semibold text-emerald-400"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Time Frames -->
                        <div class="pt-4 border-t border-gray-700">
                            <h3 class="text-lg font-semibold mb-4 text-emerald-400">Time Frames</h3>
                            <div class="space-y-4">
                                 <div>
                                    <div class="flex justify-between items-center">
                                        <label for="timeHorizon" class="block text-xs md:text-sm font-medium text-gray-300">Total Investment Horizon (Years)</label>
                                         <div class="relative group">
                                            <span class="text-emerald-400 cursor-help">ⓘ</span>
                                            <div class="tooltip absolute bottom-full mb-2 w-64 bg-gray-800 border border-gray-700 text-white text-xs rounded-lg p-2 z-10">The number of years you expect to remain invested, whether using an exchange fund or selling & reinvesting.</div>
                                        </div>
                                    </div>
                                    <input type="range" id="timeHorizon" min="0" max="40" step="1" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                                    <span id="timeHorizonValue" class="block text-right font-semibold text-emerald-400"></span>
                                </div>
                                 <div id="exchangeFundPeriodContainer">
                                    <div class="flex justify-between items-center">
                                        <label for="exchangeFundPeriod" class="block text-xs md:text-sm font-medium text-gray-300">Exchange Fund Period (Years)</label>
                                        <div class="relative group">
                                            <span class="text-emerald-400 cursor-help">ⓘ</span>
                                            <div class="tooltip absolute bottom-full mb-2 w-64 bg-gray-800 border border-gray-700 text-white text-xs rounded-lg p-2 z-10">The number of years you plan to stay in the exchange fund before redeeming your shares (typically 7 years).</div>
                                        </div>
                                    </div>
                                    <input type="range" id="exchangeFundPeriod" min="0" max="40" step="1" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                                    <span id="exchangeFundPeriodValue" class="block text-right font-semibold text-emerald-400"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Expense Ratios -->
                        <div class="pt-4 border-t border-gray-700">
                             <h3 class="text-lg font-semibold mb-4 text-emerald-400">Expense Ratios</h3>
                             <div class="space-y-4">
                                 <div>
                                    <div class="flex justify-between items-center">
                                        <label for="scenarioAER" class="block text-xs md:text-sm font-medium text-gray-300">Sell & Reinvest Expense Ratio (%)</label>
                                        <div class="relative group">
                                            <span class="text-emerald-400 cursor-help">ⓘ</span>
                                            <div class="tooltip absolute bottom-full mb-2 w-64 bg-gray-800 border border-gray-700 text-white text-xs rounded-lg p-2 z-10">The annual expense ratio of the investment you would buy in the sell & reinvest scenario. Expense ratio of VOO is 0.03%.</div>
                                        </div>
                                    </div>
                                    <input type="range" id="scenarioAER" min="0" max="1" step="0.01" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                                    <span id="scenarioAERValue" class="block text-right font-semibold text-emerald-400"></span>
                                </div>
                                <div>
                                    <div class="flex justify-between items-center">
                                        <label for="exchangeFundER" class="block text-xs md:text-sm font-medium text-gray-300">Exchange Fund Expense Ratio (%)</label>
                                         <div class="relative group">
                                            <span class="text-emerald-400 cursor-help">ⓘ</span>
                                            <div class="tooltip absolute bottom-full mb-2 w-64 bg-gray-800 border border-gray-700 text-white text-xs rounded-lg p-2 z-10">The annual expense ratio of the exchange fund you’re considering.</div>
                                        </div>
                                    </div>
                                    <input type="range" id="exchangeFundER" min="0" max="3" step="0.01" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                                    <div class="flex justify-end items-center mt-1">
                                        <span id="exchangeFundERValue" class="block font-semibold text-emerald-400"></span>
                                        <span id="breakEvenIndicator" class="text-xs font-bold px-2 py-1 rounded-md ml-2"></span>
                                    </div>
                                </div>
                                <div>
                                     <div class="flex justify-between items-center">
                                        <label for="postFundER" class="block text-xs md:text-sm font-medium text-gray-300">Exchange Fund Post-Redemption ER (%)</label>
                                         <div class="relative group">
                                            <span class="text-emerald-400 cursor-help">ⓘ</span>
                                            <div class="tooltip absolute bottom-full mb-2 w-64 bg-gray-800 border border-gray-700 text-white text-xs rounded-lg p-2 z-10">The annual expense ratio of the investment you'd own after redeeming your exchange fund shares. Expense ratio of VOO is 0.03%.</div>
                                        </div>
                                    </div>
                                    <input type="range" id="postFundER" min="0" max="1" step="0.01" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                                    <span id="postFundERValue" class="block text-right font-semibold text-emerald-400"></span>
                                </div>
                             </div>
                        </div>
                    </div>
                </aside>

                <!-- Right Panel: Results & Charts -->
                <section class="lg:col-span-2 space-y-8">
                     <div id="result-container" class="mb-4">
                        <!-- Result Banner will be injected here by JavaScript -->
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div id="sellReinvestBox" class="bg-gray-900 p-4 rounded-2xl shadow-lg border-2 border-gray-700 text-center flex flex-col justify-between transition-all duration-300">
                            <h3 class="text-xl md:text-2xl font-bold text-[#f6935f] mb-2">Sell & Reinvest</h3>
                            <div>
                                <p id="finalValueA" class="text-2xl md:text-3xl font-bold text-[#f6935f]">$0</p>
                                <p class="text-xs text-gray-400">Final Real After-Tax</p>
                            </div>
                            <div class="mt-2 pt-2 border-t border-gray-700">
                                <p id="nominalValueA" class="text-lg md:text-xl font-semibold text-gray-400">$0</p>
                                <p class="text-xs text-gray-500">Nominal Pre-Tax</p>
                            </div>
                            <div class="mt-2 pt-2 border-t border-gray-700">
                                <p id="taxesPaidA" class="text-lg md:text-xl font-semibold text-gray-400">$0</p>
                                <p class="text-xs text-gray-500">Total Taxes Paid</p>
                            </div>
                        </div>
                         <div id="exchangeFundBox" class="bg-gray-900 p-4 rounded-2xl shadow-lg border-2 border-gray-700 text-center flex flex-col justify-between transition-all duration-300">
                            <h3 class="text-xl md:text-2xl font-bold text-cyan-400 mb-2">Exchange Fund</h3>
                            <div>
                                <p id="finalValueB" class="text-xl md:text-2xl font-bold text-cyan-400">$0</p>
                                <p class="text-xs text-gray-400">Final Real After-Tax</p>
                            </div>
                            <div class="mt-2 pt-2 border-t border-gray-700">
                                <p id="nominalValueB" class="text-lg md:text-xl font-semibold text-gray-400">$0</p>
                                <p class="text-xs text-gray-500">Nominal Pre-Tax</p>
                            </div>
                            <div class="mt-2 pt-2 border-t border-gray-700">
                                <p id="taxesPaidB" class="text-lg md:text-xl font-semibold text-gray-400">$0</p>
                                <p class="text-xs text-gray-500">Total Taxes Paid</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-900 p-6 rounded-2xl border border-gray-700">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4 md:gap-0">
                             <h3 class="text-lg md:text-xl font-bold text-white">Value Over Time Comparison</h3>
                            <div class="flex items-center">
                                 <span class="text-sm font-medium text-gray-300 mr-2">Nominal Pre-Tax</span>
                                 <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="toggle" id="taxToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" checked/>
                                    <label for="taxToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-600 cursor-pointer"></label>
                                </div>
                                <span class="text-sm font-medium text-gray-300">Real After-Tax</span>
                            </div>
                        </div>
                        <div class="chart-container mx-auto">
                            <canvas id="valueOverTimeChart"></canvas>
                        </div>
                        <div class="text-center mt-4">
                            <button id="exportCsvBtn" class="inline-flex items-center gap-2 bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-700 transition-colors">
                                <i class="fas fa-download mr-2"></i>
                                <span>Export Chart Data as CSV</span>
                            </button>
                        </div>
                    </div>

                    <div class="bg-gray-900 p-6 rounded-2xl border border-gray-700 flex flex-col md:flex-row items-center">
                        <div class="w-full md:w-1/3 text-center mb-4 md:mb-0 md:pr-4 md:border-r md:border-gray-700">
                            <h3 class="text-xl md:text-2xl font-bold text-white mb-2">Break-Even<br>Expense Ratio</h3>
                            <p id="breakEvenER" class="text-3xl sm:text-4xl md:text-5xl font-extrabold text-emerald-400">0.75%</p>
                        </div>
                        <div class="w-full md:w-2/3 md:pl-6">
                            <p class="text-sm md:text-base text-gray-400">This is the maximum annual fee an exchange fund can charge and still give you a better outcome than selling your stock now.</p>
                            <br>
                            <p class="text-sm md:text-base text-gray-400">If your exchange fund's expense ratio is <span class="font-bold">lower</span>, then it's better to use the <span class="font-bold text-cyan-400">exchange fund</span>. If it's <span class="font-bold">higher</span>, then <span class="font-bold text-[#f6935f]">sell & reinvest</span> is the better choice.</p>
                        </div>
                    </div>

                    <div class="bg-gray-900 p-6 rounded-2xl border border-gray-700">
                        <h3 class="text-lg md:text-xl font-bold mb-4 text-center text-white">Break-Even Expense Ratio vs. Time Horizon</h3>
                        <div class="chart-container mx-auto">
                            <canvas id="sensitivityChart"></canvas>
                        </div>
                        <div class="text-center mt-4">
                            <button id="exportSensitivityCsvBtn" class="inline-flex items-center gap-2 bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-700 transition-colors">
                                <i class="fas fa-download mr-2"></i>
                                <span>Export Chart Data as CSV</span>
                            </button>
                        </div>
                    </div>

                    <!-- Tax Chart -->
                    <div class="bg-gray-900 p-6 rounded-2xl border border-gray-700">
                        <h3 class="text-lg md:text-xl font-bold mb-4 text-center text-white">Taxes Paid Over Time</h3>
                        <div id="taxChart" class="chart-container mx-auto"></div>
                        <p class="text-xs text-gray-500 text-center mt-2">This chart shows when taxes are paid in each scenario. For "Sell & Reinvest," tax is paid on the initial sale (Year 0) and again on gains at the end. For the "Exchange Fund," tax is deferred until the end of the investment horizon.</p>
                        <div class="text-center mt-4">
                            <button id="exportTaxesCsvBtn" class="inline-flex items-center gap-2 bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-700 transition-colors">
                                <i class="fas fa-download mr-2"></i>
                                <span>Export Chart Data as CSV</span>
                            </button>
                        </div>
                    </div>
                </section>
            </main>

            <!-- Key Assumptions & Notes Section -->
            <div class="mt-12">
                <h3 class="text-lg md:text-xl font-bold mb-4 text-center text-white">Key Assumptions & Notes</h3>
                <ul class="max-w-3xl mx-auto list-disc list-inside text-gray-400 space-y-2 text-sm">
                    <li>Taxes are calculated based on the long-term capital gains rate provided. The model assumes all gains are long-term.</li>
                    <li>For simplicity, taxes are paid at Year 0 (for the "Sell & Reinvest" scenario) and at the end of the total investment horizon.</li>
                    <li>All returns are compounded annually, including investment returns and the effect of expense ratios.</li>
                    <li>The model does not account for dividends or other distributions from investments.</li>
                    <li>The "Tax Rate" input should be your combined federal, state, and local capital gains rate.</li>
                    <li>This is a simplified financial model and does not account for all possible market conditions or tax law changes.</li>
                </ul>
            </div>

            <p class="text-center text-xs text-gray-500 mt-12">This tool is for informational purposes only and does not constitute financial advice. Consult with a qualified financial advisor and tax professional.</p>
        </div>
    </section>

   <section class="bg-gray-900 pt-12 pb-20">
        <div class="container mx-auto px-6">
             <h2 class="text-xl md:text-2xl font-bold text-center mb-6 text-white">Learn More</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 text-sm">
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                    <h4 class="font-bold text-emerald-400 mb-2">Understanding Concentrated Stock Risk</h4>
                    <p class="text-gray-400">Why holding a large position in a single stock can be riskier than you think.</p>
                    <a href="https://kaching-labs.com/concentrated_wealth/understanding_concentrated_stock_risk.html" class="block text-emerald-400 hover:text-emerald-300 transition-colors mt-2">
                        Read More &rarr;
                    </a>
                </div>
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                    <h4 class="font-bold text-emerald-400 mb-2">Intro To Exchange Funds</h4>
                    <p class="text-gray-400">How these specialized funds work and who they are best suited for.</p>
                    <a href="https://kaching-labs.com/concentrated_wealth/intro_to_exchange_funds.html" class="block text-emerald-400 hover:text-emerald-300 transition-colors mt-2">
                        Read More &rarr;
                    </a>
                </div>
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                    <h4 class="font-bold text-emerald-400 mb-2">Lock-Up Period</h4>
                    <p class="text-gray-400">Exchange funds typically require you to keep your money in the fund for a minimum period, often seven years, to achieve the tax deferral. This reduces your liquidity.</p>
                </div>
                 <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                    <h4 class="font-bold text-emerald-400 mb-2">Fund Quality & Returns</h4>
                    <p class="text-gray-400">This analysis depends heavily on your return assumptions for both scenarios. You must be confident that the portfolios can achieve the returns you have modeled.</p>
                </div>
                 <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                    <h4 class="font-bold text-emerald-400 mb-2">Estate Planning</h4>
                    <p class="text-gray-400">If you hold the exchange fund position until death, your heirs may receive a step-up in basis on its value, potentially eliminating the deferred capital gains tax entirely. This can be a powerful advantage.</p>
                </div>
                 <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                    <h4 class="font-bold text-emerald-400 mb-2">Taxes</h4>
                    <p class="text-gray-400">A high tax rate makes tax deferral significantly more valuable and raises the break-even expense ratio. Ensure your tax rate input reflects federal, state, and any other capital gains taxes.</p>
                </div>
            </div>
        </div>
    </section>

    <footer class="bg-gray-800 border-t border-gray-700">
        <div class="container mx-auto px-6 py-8 text-center text-gray-400">
            <a href="https://KaChing-Labs.com" class="text-base md:text-lg font-semibold text-white">KaChing <span class="text-emerald-400">Labs</span></a>
            <p class="mt-2 text-sm">Intelligent tools for your financial journey.</p>
            <p class="mt-4 text-xs">
                &copy; 2025 KaChing Labs. All Rights Reserved.
                <span class="mx-2 text-gray-600">|</span>
                <a href="https://kaching-labs.com/legal.html" class="hover:text-emerald-400 underline">Legal Information</a>
            </p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- CENTRALIZED CONFIGURATION ---
            const config = {
                palette: {
                scenarioA: '#f6935f',
                    scenarioA_bg: 'rgba(246, 147, 95, 0.1)',
                scenarioB: '#22D3EE', // cyan-400
                    scenarioB_bg: 'rgba(34, 211, 238, 0.1)',
                scenarioA_sensitivity_chart_bg: 'rgba(246, 147, 95, 0.7)',
                scenarioB_sensitivity_chart_bg: 'rgba(34, 211, 238, 0.7)',
                winner: '#34D399', // emerald-400
                    tie: {
                        bg: '#374151',      // gray-700
                        border: '#6B7280',  // gray-500
                        icon_base: '#4B5563', // gray-600
                        icon_symbol: '#D1D5DB', // gray-300
                        text: '#FFFFFF'     // white
                    },
                    text: '#9CA3AF', // text-gray-400
                    border: '#4B5563', // border-gray-600
                    tooltipBg: '#1F2937', // bg-gray-800
                    tooltipText: '#D1D5DB' // text-gray-300
                },
                initialInputs: {
                    currentValue: '1,000,000',
                    costBasis: '200,000',
                    taxRate: 23.8,
                    scenarioAAnnualReturn: 10.0,
                    exchangeFundAnnualReturn: 10.0,
                    postFundAnnualReturn: 10.0,
                    inflation: 3.3,
                    timeHorizon: 20,
                    exchangeFundPeriod: 7,
                    scenarioAER: 0.03,
                    exchangeFundER: 1.25,
                    postFundER: 0.03,
                },
                sensitivityChartMaxHorizon: 40,
            };

            // Set Chart.js defaults for dark theme
            Chart.defaults.color = config.palette.text;
            Chart.defaults.borderColor = config.palette.border;

            // --- STATE MANAGEMENT ---
            let chartDataForExport = [];
            let sensitivityDataForExport = [];
            let taxDataForExport = [];

            // --- DOM ELEMENT REFERENCES ---
            const inputs = {
                currentValue: document.getElementById('currentValue'),
                costBasis: document.getElementById('costBasis'),
                taxRate: document.getElementById('taxRate'),
                scenarioAAnnualReturn: document.getElementById('scenarioAAnnualReturn'),
                exchangeFundAnnualReturn: document.getElementById('exchangeFundAnnualReturn'),
                postFundAnnualReturn: document.getElementById('postFundAnnualReturn'),
                inflation: document.getElementById('inflation'),
                timeHorizon: document.getElementById('timeHorizon'),
                exchangeFundPeriod: document.getElementById('exchangeFundPeriod'),
                scenarioAER: document.getElementById('scenarioAER'),
                exchangeFundER: document.getElementById('exchangeFundER'),
                postFundER: document.getElementById('postFundER'),
                taxToggle: document.getElementById('taxToggle'),
                exportCsvBtn: document.getElementById('exportCsvBtn'),
                exportSensitivityCsvBtn: document.getElementById('exportSensitivityCsvBtn'),
                exportTaxesCsvBtn: document.getElementById('exportTaxesCsvBtn'),
            };

            const displays = {
                taxRateValue: document.getElementById('taxRateValue'),
                scenarioAAnnualReturnValue: document.getElementById('scenarioAAnnualReturnValue'),
                exchangeFundAnnualReturnValue: document.getElementById('exchangeFundAnnualReturnValue'),
                postFundAnnualReturnValue: document.getElementById('postFundAnnualReturnValue'),
                inflationValue: document.getElementById('inflationValue'),
                timeHorizonValue: document.getElementById('timeHorizonValue'),
                exchangeFundPeriodValue: document.getElementById('exchangeFundPeriodValue'),
                scenarioAERValue: document.getElementById('scenarioAERValue'),
                exchangeFundERValue: document.getElementById('exchangeFundERValue'),
                postFundERValue: document.getElementById('postFundERValue'),
                finalValueA: document.getElementById('finalValueA'),
                nominalValueA: document.getElementById('nominalValueA'),
                taxesPaidA: document.getElementById('taxesPaidA'),
                finalValueB: document.getElementById('finalValueB'),
                nominalValueB: document.getElementById('nominalValueB'),
                taxesPaidB: document.getElementById('taxesPaidB'),
                breakEvenER: document.getElementById('breakEvenER'),
                resultContainer: document.getElementById('result-container'),
                breakEvenIndicator: document.getElementById('breakEvenIndicator'),
            };

            // --- FORMATTERS ---
            const currencyFormatter = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
            });

            const numberFormatter = new Intl.NumberFormat('en-US');

            // --- CHART INSTANCES ---
            let valueOverTimeChart, sensitivityChart, taxChart;

            // --- CHART UPDATE FUNCTIONS ---
            function updateValueOverTimeChart(labels, dataA, dataB, isPreTax) {
                if (!valueOverTimeChart) return;
                valueOverTimeChart.data.labels = labels;
                valueOverTimeChart.data.datasets[0].data = dataA;
                valueOverTimeChart.data.datasets[1].data = dataB;
                valueOverTimeChart.options.scales.y.title.text = isPreTax ? 'Nominal Pre-Tax Value' : 'Real After-Tax Value';
                valueOverTimeChart.options.plugins.tooltip.callbacks.title = (tooltipItems) => tooltipItems.length > 0 ? `Year ${tooltipItems[0].label}`: '';
                valueOverTimeChart.update();
            }

            function updateTaxChart(labels, taxDataA, taxDataB) {
                if (!taxChart) return;
                const option = {
                    backgroundColor: 'transparent',
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { type: 'shadow' },
                        backgroundColor: config.palette.tooltipBg,
                        borderColor: config.palette.border,
                        textStyle: { color: config.palette.tooltipText },
                        formatter: (params) => {
                            let tooltipText = `Year ${params[0].name}<br/>`;
                            params.forEach(param => {
                                tooltipText += `${param.marker} ${param.seriesName}: ${currencyFormatter.format(param.value)}<br/>`;
                            });
                            return tooltipText;
                        }
                    },
                    legend: {
                        data: ['Sell & Reinvest', 'Exchange Fund'],
                        textStyle: { color: config.palette.tooltipText }
                    },
                    grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                    xAxis: { type: 'category', data: labels, axisLabel: { color: config.palette.text } },
                    yAxis: {
                        type: 'value',
                        name: 'Taxes Paid',
                        nameTextStyle: { color: config.palette.text, padding: [0, 0, 0, 60] },
                        axisLabel: {
                            color: config.palette.text,
                            formatter: (value) => {
                                if (value >= 1e6) return currencyFormatter.format(value / 1e6) + 'M';
                                if (value >= 1e3) return currencyFormatter.format(value / 1e3) + 'K';
                                return currencyFormatter.format(value);
                            }
                        },
                        splitLine: { lineStyle: { color: config.palette.border } }
                    },
                    series: [
                        { name: 'Sell & Reinvest', type: 'bar', data: taxDataA, itemStyle: { color: config.palette.scenarioA } },
                        { name: 'Exchange Fund', type: 'bar', data: taxDataB, itemStyle: { color: config.palette.scenarioB } }
                    ]
                };
                taxChart.setOption(option);
            }

            function updateSensitivityChart(data) {
                if (!sensitivityChart) return;
                sensitivityChart.data.datasets.forEach(dataset => { dataset.data = data; });
                sensitivityChart.update();
            }

            // --- UI UPDATE FUNCTION ---
            function updateDisplayValues() {
                 Object.keys(displays).forEach(key => {
                    const sliderId = key.replace('Value', '');
                    if (!inputs[sliderId] || inputs[sliderId].type !== 'range') return;

                        const slider = inputs[sliderId];
                        const displayEl = displays[key];
                        const value = parseFloat(slider.value);

                        if (slider.id === 'timeHorizon' || slider.id === 'exchangeFundPeriod') {
                            displayEl.textContent = `${value} Years`;
                        } else if (['scenarioAER', 'exchangeFundER', 'postFundER'].includes(slider.id)) {
                            displayEl.textContent = `${value.toFixed(2)}%`;
                        } else {
                            displayEl.textContent = `${value.toFixed(1)}%`;
                        }
                });
            }

            // --- CORE CALCULATION LOGIC ---
            function calculate() {
                const N = parseInt(inputs.timeHorizon.value, 10);
                const exchangeFundPeriod = parseInt(inputs.exchangeFundPeriod.value, 10);

                // --- Input Validation ---
                const isError = exchangeFundPeriod > N;
                document.querySelector('label[for="exchangeFundPeriod"]').classList.toggle('text-red-500', isError);
                displays.exchangeFundPeriodValue.classList.toggle('text-red-500', isError);
                inputs.exchangeFundPeriod.classList.toggle('slider-error', isError);

                if (isError) {
                    displays.resultContainer.innerHTML = `
                        <div class="bg-red-900/30 border border-red-500 rounded-lg p-4 flex items-center justify-center gap-3">
                            <i class="fas fa-triangle-exclamation text-3xl text-red-500"></i>
                            <span class="text-xl md:text-2xl font-black text-red-400">Error: Exchange Fund Period cannot exceed Total Investment Horizon</span>
                        </div>`;
                    ['finalValueA', 'nominalValueA', 'taxesPaidA', 'finalValueB', 'nominalValueB', 'taxesPaidB'].forEach(key => displays[key].textContent = '–');
                    displays.breakEvenER.textContent = 'N/A';
                    if (valueOverTimeChart) updateValueOverTimeChart([], [], [], true);
                    if (sensitivityChart) updateSensitivityChart([]);
                    if (taxChart) updateTaxChart([], [], []);
                    return;
                } else {
                     displays.resultContainer.innerHTML = '';
                }

                // --- Read Inputs ---
                const V = parseFloat(inputs.currentValue.value.replace(/,/g, '')) || 0;
                const B = parseFloat(inputs.costBasis.value.replace(/,/g, '')) || 0;
                const T = parseFloat(inputs.taxRate.value) / 100 || 0;
                const R_A_nominal = parseFloat(inputs.scenarioAAnnualReturn.value) / 100 || 0;
                const R_B_nominal = parseFloat(inputs.exchangeFundAnnualReturn.value) / 100 || 0;
                const R_post_fund_nominal = parseFloat(inputs.postFundAnnualReturn.value) / 100 || 0;
                const I = parseFloat(inputs.inflation.value) / 100 || 0;
                const ER_low = parseFloat(inputs.scenarioAER.value) / 100 || 0;
                const userSetER = parseFloat(inputs.exchangeFundER.value) / 100 || 0;
                const postFundER = parseFloat(inputs.postFundER.value) / 100 || 0;
                const showRealAfterTax = inputs.taxToggle.checked;

                // --- Core Financial Calculations ---
                const R_A_nominal_net = R_A_nominal - ER_low;

                // This is the initial gain (if V > B) or 0.
                const initialGain = Math.max(0, V - B);
                // This is the initial loss (if B > V) or 0. This is the carryforward amount.
                const capitalLossCarryforward = Math.max(0, B - V);
                const initialTaxA = initialGain * T;

                const getNominalFutureValueB = (er_x, years) => {
                    const R_B_high_ER_net = R_B_nominal - er_x;
                    const efp = Math.min(years, exchangeFundPeriod);

                    if (years <= efp) {
                         return V * Math.pow(1 + R_B_high_ER_net, years);
                    } else {
                        const valueAtFundEnd = V * Math.pow(1 + R_B_high_ER_net, efp);
                        const remainingYears = years - efp;
                        const R_post_fund_scenario_net = R_post_fund_nominal - postFundER;
                        return valueAtFundEnd * Math.pow(1 + R_post_fund_scenario_net, remainingYears);
                    }
                };

                const calcScenarioA = (years) => {
                    // Principal is the after-tax proceeds from the initial sale.
                    const principal = V - initialTaxA;
                    const nominalFutureValue = principal * Math.pow(1 + R_A_nominal_net, years);

                    // Gain from the new investment.
                    const reinvestmentGain = nominalFutureValue - principal;

                    // The loss carryforward offsets the new gain.
                    const netTaxableGain = Math.max(0, reinvestmentGain - capitalLossCarryforward);
                    const futureTax = netTaxableGain * T;
                    return (nominalFutureValue - futureTax) / Math.pow(1 + I, years);
                };

                const calcScenarioB = (er_x, years) => {
                    const nominalFutureValue = getNominalFutureValueB(er_x, years);
                    // The gain is calculated against the original high cost basis.
                    const nominalGain = nominalFutureValue - B;
                    // Tax is only applied to positive gains.
                    const futureTax = Math.max(0, nominalGain) * T;
                    return (nominalFutureValue - futureTax) / Math.pow(1 + I, years);
                };

                const calcScenarioA_preTax = (years) => (V - initialTaxA) * Math.pow(1 + R_A_nominal_net, years);
                const calcScenarioB_preTax = (er_x, years) => getNominalFutureValueB(er_x, years);

                // --- Final Value Calculations ---
                const finalValueA = calcScenarioA(N);
                const finalValueB = calcScenarioB(userSetER, N);
                const nominalFutureValueA = calcScenarioA_preTax(N);
                const nominalFutureValueB = calcScenarioB_preTax(userSetER, N);

                const reinvestmentGainA = nominalFutureValueA - (V - initialTaxA);
                const finalTaxA = Math.max(0, reinvestmentGainA - capitalLossCarryforward) * T;
                const totalTaxA = initialTaxA + finalTaxA;
                const totalTaxB = Math.max(0, nominalFutureValueB - B) * T;

                let breakEvenER = 0;
                if (exchangeFundPeriod > 0 && N > 0) {
                    let high = R_B_nominal, low = -1;
                    for (let i = 0; i < 50; i++) {
                        let mid = (high + low) / 2;
                        calcScenarioB(mid, N) > finalValueA ? low = mid : high = mid;
                    }
                    breakEvenER = low;
                }

                // --- Update UI Displays ---
                displays.finalValueA.textContent = currencyFormatter.format(finalValueA);
                displays.nominalValueA.textContent = currencyFormatter.format(nominalFutureValueA);
                displays.taxesPaidA.textContent = currencyFormatter.format(totalTaxA);
                displays.finalValueB.textContent = currencyFormatter.format(finalValueB);
                displays.nominalValueB.textContent = currencyFormatter.format(nominalFutureValueB);
                displays.taxesPaidB.textContent = currencyFormatter.format(totalTaxB);

                const breakEvenERPercentage = breakEvenER * 100;
                const roundedDownER = Math.floor(breakEvenERPercentage * 100) / 100;
                displays.breakEvenER.textContent = (exchangeFundPeriod > 0 && N > 0) ? `${roundedDownER.toFixed(2)}%` : 'N/A';

                // Update Break-Even Indicator
                if (breakEvenER > 0) {
                    const isGood = userSetER * 100 < roundedDownER;
                    displays.breakEvenIndicator.textContent = isGood ? 'Good' : 'High';
                    displays.breakEvenIndicator.className = `text-xs font-bold px-2 py-1 rounded-md ml-2 ${isGood ? 'bg-emerald-500/20 text-emerald-400' : 'bg-amber-500/20 text-amber-400'}`;
                } else {
                    displays.breakEvenIndicator.textContent = '';
                }

                // --- Prepare and Update Charts ---
                const labels = Array.from({ length: N + 1 }, (_, i) => i);
                const valueDataA = labels.map(year => calcScenarioA(year));
                const valueDataB = labels.map(year => calcScenarioB(userSetER, year));
                const preTaxDataA = labels.map(year => calcScenarioA_preTax(year));
                const preTaxDataB = labels.map(year => calcScenarioB_preTax(userSetER, year));
                updateValueOverTimeChart(labels, showRealAfterTax ? valueDataA : preTaxDataA, showRealAfterTax ? valueDataB : preTaxDataB, !showRealAfterTax);

                const yearlyTaxA = Array(N + 1).fill(0);
                if (N > 0) { yearlyTaxA[0] = initialTaxA; yearlyTaxA[N] = finalTaxA; }
                else { yearlyTaxA[0] = totalTaxA; }
                const yearlyTaxB = Array(N + 1).fill(0);
                if (N >= 0) yearlyTaxB[N] = totalTaxB;
                updateTaxChart(labels, yearlyTaxA, yearlyTaxB);

                sensitivityDataForExport = [];
                for (let year = 1; year <= config.sensitivityChartMaxHorizon; year++) {
                    let yearBreakEven = 0;
                     if (year > 0) {
                        let h = R_B_nominal, l = -1;
                        for (let i = 0; i < 50; i++) {
                            let m = (h + l) / 2;
                            calcScenarioB(m, year) > calcScenarioA(year) ? l = m : h = m;
                        }
                        yearBreakEven = l;
                    }
                    sensitivityDataForExport.push({ x: year, y: yearBreakEven * 100 });
                }
                updateSensitivityChart(sensitivityDataForExport);

                // --- Prepare Data for CSV Export ---
                taxDataForExport = labels.map((year, i) => ({ year, tax_a: yearlyTaxA[i], tax_b: yearlyTaxB[i] }));
                chartDataForExport = labels.map((year, i) => ({
                    year,
                    real_after_tax_a: valueDataA[i],
                    nominal_pre_tax_a: preTaxDataA[i],
                    total_tax_a: yearlyTaxA[i],
                    real_after_tax_b: valueDataB[i],
                    nominal_pre_tax_b: preTaxDataB[i],
                    total_tax_b: yearlyTaxB[i],
                }));

                // --- Update Winner/Loser Highlighting ---
                const sellReinvestBox = document.getElementById('sellReinvestBox');
                const exchangeFundBox = document.getElementById('exchangeFundBox');

                // Reset styles
                sellReinvestBox.style.backgroundColor = '';
                sellReinvestBox.style.borderColor = config.palette.border;
                sellReinvestBox.style.opacity = '1';
                exchangeFundBox.style.backgroundColor = '';
                exchangeFundBox.style.borderColor = config.palette.border;
                exchangeFundBox.style.opacity = '1';

                let resultHTML = '';
                if (Math.abs(finalValueA - finalValueB) < 1) {
                    // Tie
                    resultHTML = `<div class="bg-[${config.palette.tie.bg}]/50 border border-[${config.palette.tie.border}] rounded-lg p-4 flex items-center justify-center gap-3"><span class="fa-stack fa-1x"><i class="fas fa-circle fa-stack-2x text-[${config.palette.tie.icon_base}]"></i><i class="fas fa-equals fa-stack-1x fa-inverse text-[${config.palette.tie.icon_symbol}]"></i></span><span class="text-2xl md:text-3xl font-black text-[${config.palette.tie.text}]">Outcomes are effectively the same</span></div>`;
                } else if (finalValueA > finalValueB) {
                    // A wins
                    sellReinvestBox.style.backgroundColor = config.palette.scenarioA_bg;
                    sellReinvestBox.style.borderColor = config.palette.scenarioA;
                    exchangeFundBox.style.opacity = '0.75';
                    resultHTML = `<div class="bg-[${config.palette.scenarioA}]/10 border border-[${config.palette.scenarioA}] rounded-lg p-4 flex items-center justify-center gap-3"><span class="fa-stack fa-1x"><i class="fas fa-circle fa-stack-2x text-[${config.palette.scenarioA}]/80"></i><i class="fas fa-seedling fa-stack-1x fa-inverse text-gray-900"></i></span><span class="text-2xl md:text-3xl font-black text-[${config.palette.scenarioA}]">Sell & Reinvest is Better</span></div>`;
                } else {
                    // B wins
                    exchangeFundBox.style.backgroundColor = config.palette.scenarioB_bg;
                    exchangeFundBox.style.borderColor = config.palette.scenarioB;
                    sellReinvestBox.style.opacity = '0.75';
                    resultHTML = `<div class="bg-[${config.palette.scenarioB}]/10 border border-[${config.palette.scenarioB}] rounded-lg p-4 flex items-center justify-center gap-3"><span class="fa-stack fa-1x"><i class="fas fa-circle fa-stack-2x text-[${config.palette.scenarioB}]/80"></i><i class="fas fa-rotate fa-stack-1x fa-inverse text-gray-900"></i></span><span class="text-2xl md:text-3xl font-black text-[${config.palette.scenarioB}]">Exchange Fund is Better</span></div>`;
                }
                displays.resultContainer.innerHTML = resultHTML;
            }

            // --- CHART CREATION ---
            function createCharts() {
                valueOverTimeChart = new Chart(document.getElementById('valueOverTimeChart').getContext('2d'), {
                    type: 'line',
                    data: {
                        datasets: [
                            { label: 'Sell & Reinvest', borderColor: config.palette.scenarioA, backgroundColor: config.palette.scenarioA, fill: false, tension: 0.1, pointRadius: 3 },
                            { label: 'Exchange Fund', borderColor: config.palette.scenarioB, backgroundColor: config.palette.scenarioB, fill: false, tension: 0.1, pointRadius: 3 }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top', labels: { color: config.palette.tooltipText } },
                            tooltip: {
                                mode: 'index', intersect: false,
                                callbacks: {
                                    title: (items) => items.length ? `Year ${items[0].label}` : '',
                                    label: (context) => `${context.dataset.label || ''}: ${currencyFormatter.format(context.parsed.y)}`
                                }
                            }
                        },
                        scales: {
                            x: { title: { display: true, text: 'Year' }, ticks: { color: config.palette.text } },
                            y: {
                                title: { display: true, text: 'Real After-Tax Value' },
                                ticks: {
                                    color: config.palette.text,
                                    callback: (value) => {
                                        if (value >= 1e9) return currencyFormatter.format(value / 1e9) + 'B';
                                        if (value >= 1e6) return currencyFormatter.format(value / 1e6) + 'M';
                                        if (value >= 1e3) return currencyFormatter.format(value / 1e3) + 'K';
                                        return currencyFormatter.format(value);
                                    }
                                }
                            }
                        }
                    }
                });

                // --- ANNOTATION PLUGIN ---
                const annotationPlugin = {
                    id: 'chartAnnotations',
                    beforeDatasetsDraw: (chart) => {
                        const { ctx, chartArea } = chart;
                        const wrapText = (context, text, x, y, maxWidth, lineHeight) => {
                            const words = text.split(' '); let line = ''; let lineArray = [];
                            for(let n = 0; n < words.length; n++) {
                                let testLine = line + words[n] + ' ';
                                if (context.measureText(testLine).width > maxWidth && n > 0) { lineArray.push(line); line = words[n] + ' '; }
                                else { line = testLine; }
                            }
                            lineArray.push(line);
                            for(let k = 0; k < lineArray.length; k++) context.fillText(lineArray[k], x, y + (k * lineHeight));
                        };
                        ctx.save();
                        const fontSize = Math.max(12, Math.min(30, chart.width / 25));
                        ctx.font = `600 ${fontSize}px Inter`;

                        // Define text properties
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                        const padding = 20; const maxWidth = chartArea.width - (padding * 2); const lineHeight = fontSize * 1.2;
                        ctx.textAlign = 'left'; ctx.textBaseline = 'top';
                        wrapText(ctx, 'Sell & Reinvest is Better', chartArea.left + padding, chartArea.top + padding, maxWidth, lineHeight);
                        ctx.textAlign = 'right'; ctx.textBaseline = 'bottom';
                        wrapText(ctx, 'Exchange Fund is Better', chartArea.right - padding, chartArea.bottom - padding, maxWidth, lineHeight);
                        ctx.restore();
                    }
                };

                sensitivityChart = new Chart(document.getElementById('sensitivityChart').getContext('2d'), {
                    type: 'line',
                    data: {
                        datasets: [
                            { label: 'Break-Even Expense Ratio', borderColor: config.palette.winner, borderWidth: 3, backgroundColor: config.palette.scenarioB_sensitivity_chart_bg, fill: 'start', tension: 0.4, pointRadius: 2, pointBackgroundColor: config.palette.winner, pointBorderColor: config.palette.winner, pointBorderWidth: 2 },
                            { label: 'Area where Sell & Reinvest is better', borderColor: 'transparent', borderWidth: 0, backgroundColor: config.palette.scenarioA_sensitivity_chart_bg, fill: 'end', tension: 0.4, pointRadius: 0 }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                mode: 'index', intersect: false,
                                filter: (item) => item.dataset.label === 'Break-Even Expense Ratio',
                                callbacks: {
                                     title: (items) => items.length ? `Year ${items[0].raw.x}`: '',
                                     label: (context) => `Break-even Expense Ratio: ${context.raw.y.toFixed(2)}%`,
                                     labelColor: () => ({ borderColor: config.palette.winner, backgroundColor: config.palette.winner })
                                }
                            }
                        },
                        scales: {
                            x: { type: 'linear', title: { display: true, text: 'Investment Time Horizon (Years)' }, min: 1, ticks: { color: config.palette.text } },
                            y: { title: { display: true, text: 'Break-Even Expense Ratio (%)' }, beginAtZero: false, ticks: { color: config.palette.text } }
                        }
                    },
                    plugins: [annotationPlugin]
                });

                taxChart = echarts.init(document.getElementById('taxChart'));
            }

            // --- CSV EXPORT ---
            function exportToCsv(data, filename) {
                let csvContent = "data:text/csv;charset=utf-8,";
                const formatForCsv = (num) => `"${num.toFixed(2)}"`;
                if (filename === 'Scenario_Comparison.csv') {
                    csvContent += "Year,Sell_Reinvest_Nominal_Pre_Tax,Sell_Reinvest_Real_After_Tax,Sell_Reinvest_Taxes_Paid,Exchange_Fund_Nominal_Pre_Tax,Exchange_Fund_Real_After_Tax,Exchange_Fund_Taxes_Paid\r\n";
                     data.forEach(row => { csvContent += [row.year, formatForCsv(row.nominal_pre_tax_a), formatForCsv(row.real_after_tax_a), formatForCsv(row.total_tax_a), formatForCsv(row.nominal_pre_tax_b), formatForCsv(row.real_after_tax_b), formatForCsv(row.total_tax_b)].join(",") + "\r\n"; });
                } else if (filename === 'Break_Even_Expense_Ratio_VS_Time_Horizon.csv') {
                     csvContent += "Year,Break_Even_Expense_Ratio\r\n";
                     data.forEach(row => { csvContent += `${row.x},"${row.y.toFixed(4)}%"\r\n`; });
                } else if (filename === 'Taxes_Paid_Over_Time.csv') {
                    csvContent += "Year,Sell_Reinvest_Taxes_Paid,Exchange_Fund_Taxes_Paid\r\n";
                    data.forEach(row => { csvContent += [row.year, formatForCsv(row.tax_a), formatForCsv(row.tax_b)].join(",") + "\r\n"; });
                }
                const link = document.createElement("a");
                link.setAttribute("href", encodeURI(csvContent));
                link.setAttribute("download", filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // --- TOOLTIP POSITIONING ---
            function adjustTooltipPosition(tooltip) {
                // Reset styles to default (centered above the icon) to measure it correctly
                tooltip.style.left = '50%';
                tooltip.style.transform = 'translateX(-50%)';
                tooltip.style.right = 'auto';

                // We need to get the new bounding client rect after applying the styles
                const tooltipRect = tooltip.getBoundingClientRect();
                const viewportWidth = window.innerWidth;

                // Check for overflow and adjust
                const buffer = 16; // 1rem buffer from viewport edges
                if (tooltipRect.left < buffer) {
                    tooltip.style.left = '0';
                    tooltip.style.right = 'auto';
                    tooltip.style.transform = `translateX(${buffer}px)`; // Add buffer
                } else if (tooltipRect.right > viewportWidth - buffer) {
                    tooltip.style.left = 'auto';
                    tooltip.style.right = '0';
                    tooltip.style.transform = `translateX(-${buffer}px)`; // Add buffer
                }
            }


            // --- INITIALIZATION ---
            function initialize() {
                // Set initial input values from config
                Object.keys(config.initialInputs).forEach(key => {
                    if (inputs[key]) {
                        inputs[key].value = config.initialInputs[key];
                    }
                });

                // Setup event listeners for inputs
                Object.values(inputs).forEach(input => {
                    if (input.id.includes('CsvBtn')) return;
                    if (input.type === 'text') {
                        input.addEventListener('focus', (e) => { e.target.value = e.target.value.replace(/,/g, ''); });
                    input.addEventListener('blur', (e) => {
                        const value = parseFloat(e.target.value);
                            e.target.value = isNaN(value) ? '' : numberFormatter.format(value);
                        calculate();
                    });
                    } else {
                        input.addEventListener('input', () => {
                            updateDisplayValues();
                            calculate();
                        });
                    }
                });

                // Setup event listeners for CSV buttons
                inputs.exportCsvBtn.addEventListener('click', () => exportToCsv(chartDataForExport, 'Scenario_Comparison.csv'));
                inputs.exportSensitivityCsvBtn.addEventListener('click', () => exportToCsv(sensitivityDataForExport, 'Break_Even_Expense_Ratio_VS_Time_Horizon.csv'));
                inputs.exportTaxesCsvBtn.addEventListener('click', () => exportToCsv(taxDataForExport, 'Taxes_Paid_Over_Time.csv'));

                // Setup event listeners for tooltips
                document.querySelectorAll('.cursor-help').forEach(icon => {
                    const tooltip = icon.nextElementSibling;
                    icon.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const isCurrentlyVisible = tooltip.classList.contains('tooltip-visible');

                        // Hide all other tooltips first
                        document.querySelectorAll('.tooltip.tooltip-visible').forEach(visibleTooltip => {
                            visibleTooltip.classList.remove('tooltip-visible');
                        });

                        // If the clicked tooltip was not visible, show it and adjust its position.
                        if (!isCurrentlyVisible) {
                            tooltip.classList.add('tooltip-visible');
                            adjustTooltipPosition(tooltip);
                        }
                        // If it was already visible, the loop above has already hidden it, so it's now closed.
                    });
                });

                document.addEventListener('click', (e) => {
                    // Hide all tooltips if clicking anywhere else on the page, except on the help icon itself.
                    if (!e.target.classList.contains('cursor-help')) {
                        document.querySelectorAll('.tooltip.tooltip-visible').forEach(tooltip => {
                            tooltip.classList.remove('tooltip-visible');
                        });
                    }
                });

                // Resize listener for charts
                window.addEventListener('resize', () => {
                    if(valueOverTimeChart) valueOverTimeChart.resize();
                    if(sensitivityChart) sensitivityChart.resize();
                    if(taxChart) taxChart.resize();
                });

            createCharts();
            updateDisplayValues();
            calculate();
            }

            initialize();
        });
    </script>
</body>
</html>
